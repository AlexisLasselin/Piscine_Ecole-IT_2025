name: CI

on:
  push:
    branches:
      - main
      - code
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [ "3.12", "3.13" ]

    steps:
      # 1. Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up Python
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      # 3. Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-json-report -r backend/requirements.txt

      # 4. Debug: list files
      - name: List files
        run: ls -R

      # 5. Run pytest with JSON + log
      - name: Run pytest
        working-directory: backend
        run: |
          pytest -v --maxfail=5 --disable-warnings \
            --json-report --json-report-file=report.json | tee pytest-results.log

      # 6. Publish summary (table + logs)
      - name: Publish pytest summary
        if: always()
        run: |
          echo "## ðŸ§ª Pytest Results (Python ${{ matrix.python-version }})" >> $GITHUB_STEP_SUMMARY

          # Parse JSON report
          PASSED=$(jq '.summary.passed' backend/report.json)
          FAILED=$(jq '.summary.failed' backend/report.json)
          SKIPPED=$(jq '.summary.skipped' backend/report.json)
          TOTAL=$(jq '.summary.total' backend/report.json)

          echo "| âœ… Passed | âŒ Failed | âš ï¸ Skipped | ðŸ“Š Total |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----------|------------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| $PASSED | $FAILED | $SKIPPED | $TOTAL |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“‹ Detailed Log" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat backend/pytest-results.log >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
